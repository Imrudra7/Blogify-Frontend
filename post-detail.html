<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Detail | BlogiFy</title>

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <nav>
        <ul>
            <li id="home">Home</li>
            <li>About</li>
            <li>Contact Us</li>
            <li id="loadPosts" onclick="window.location.href='/'">Load All Posts</li>
        </ul>
    </nav>

    <main>
        <div id="post-detail-container">
            <div class="loading">Loading post...</div>
        </div>
    </main>
    <!-- Loader HTML -->
    <div class="loader-overlay" id="loader">
        <div class="loader-dots">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </div>
    <script>

        document.addEventListener("DOMContentLoaded", () => {
            let BASE;

            if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
                BASE = "http://localhost:8081"; // local backend
            } else {
                BASE = "https://blogify-bk6w.onrender.com"; // render backend
            }
            const loader = document.getElementById('loader');

            /**
             * Displays the loader overlay.
             */
            function showLoader() {
                if (loader) {
                    loader.classList.add('visible');
                }
            }

            /**
             * Hides the loader overlay.
             */
            function hideLoader() {
                if (loader) {
                    loader.classList.remove('visible');
                }
            }
            const postDetailContainer = document.getElementById('post-detail-container');

            // Function to get the post ID from the URL query parameter
            const getPostIdFromUrl = () => {
                const params = new URLSearchParams(window.location.search);
                return params.get('id');
            };

            // Function to fetch post data from the API
            const fetchPostDetails = async (postId) => {
                showLoader();
                // Update this URL to match your API endpoint for fetching a single post
                const url = `${BASE}/api/posts/getPostById/${postId}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        hideLoader();
                        throw new Error(`Failed to fetch post. Status: ${response.status}`);
                    }
                    const post = await response.json();
                    displayPost(post);
                } catch (error) {
                    hideLoader();
                    console.error("Error fetching post details:", error);
                    postDetailContainer.innerHTML = `<div class="error-message">Could not load post. Please try again later.</div>`;
                }
            };

            // Function to display the fetched post data in the HTML
            const displayPost = (post) => {
                // Update the page title
                document.title = `${post.title} | BlogiFy`;

                // Format the date for better readability
                const formattedDate = new Date(post.createdAt).toLocaleString('en-IN', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Create the HTML structure for the post
                postDetailContainer.innerHTML = `
            <article class="post-full">
                <h1 class="post-full-title">${post.title}</h1>
                
                <section class="post-full-meta">
                    <span class="author">By: ${post.author}</span>
                    <span class="date">Published on: ${formattedDate}</span>
                </section>
                
                <hr class="post-divider">
                
                <section class="post-full-content">
                    <p id="blog-content">${post.content}</p>
                    <textarea type="text" id="newContent" class="editor" placeholder="Write Something..." style="display:none"></textarea>
                </section>

                <section class="post-actions">
                    <button class="action-btn edit-btn">Edit Post</button>
                    <button class="action-btn delete-btn">Delete Post</button>
                </section>
            </article>
        `;
                hideLoader();
                const deletePost = document.querySelector('.delete-btn');


                if (deletePost) {


                    deletePost.addEventListener('click', async () => {
                        const confirmation = confirm("Are you sure you want to delete this post? This action cannot be undone.");
                        if (confirmation) {
                            showLoader();
                            try {
                                if (postId) {
                                    const response = await fetch(`${BASE}/api/posts/deletePostById/${postId}`, {
                                        method: "DELETE"
                                    });
                                    if (!response.ok) {
                                        hideLoader();
                                        throw new Error(`Failed to delete post. Status: ${response.status}`);
                                    }
                                    const result = await response.json();
                                    alert(result.message);
                                    hideLoader();
                                    window.location.href = "/";
                                }
                            }
                            catch (error) {
                                hideLoader();
                                console.error("Error deleting post details:", error);
                                postDetailContainer.innerHTML = `<div class="error-message">Could not delete post. Please try again later.</div>`;
                            }
                        }

                    });
                }
                const editPost = document.querySelector('.edit-btn');


                if (editPost) {
                    editPost.addEventListener('click', async () => {
                        const blog = document.getElementById('blog-content');
                        const input = document.getElementById('newContent');



                        if (editPost.innerText == 'Edit Post') {
                            showLoader();
                            input.value = blog.innerText;
                            blog.style.display = "none";
                            input.style.display = "block";
                            input.focus();
                            input.setSelectionRange(input.value.length, input.value.length);
                            editPost.innerText = "Save";
                            hideLoader();
                        } else {
                            const confirmit = confirm('Are you sure?');
                            if (confirmit) {
                                showLoader();
                                const newValue = input.value.trim();
                                if (newValue == blog.innerText) {
                                    hideLoader();
                                    return;
                                }


                                try {

                                    if (postId) {

                                        const updateResponse = await fetch(`${BASE}/api/newPosts/update-post`, {
                                            method: "PUT",
                                            headers: {
                                                "Content-Type": "application/json"
                                            },
                                            body: JSON.stringify(
                                                {
                                                    id: postId,
                                                    content: newValue
                                                }
                                            )
                                        });
                                        const data = await updateResponse.json();

                                        if (updateResponse.ok || updateResponse.status === 200) {
                                            alert(data.message)

                                            blog.innerText = newValue || blog.innerText;
                                            blog.style.display = "block";
                                            input.style.display = "none";
                                            editPost.innerText = "Edit Post";
                                            hideLoader();
                                        } else if (updateResponse.status === 304) {
                                            alert(data.message);
                                            hideLoader();
                                            console.log("Not Modified:", data.message);
                                        } else if (updateResponse.status === 404) {
                                            alert(data.message);
                                            hideLoader();
                                            console.log("Not Found:", data.message);
                                        } else {
                                            alert(data.message);
                                            hideLoader();
                                            console.log("Other error:", data.message);
                                        }
                                    }
                                } catch (error) {
                                    alert("Someting went wrong.");
                                    hideLoader();
                                    console.error(error);
                                }
                            }


                        }

                    });
                }
            };

            // --- Main Execution ---
            const postId = getPostIdFromUrl();
            if (postId) {
                fetchPostDetails(postId);
            } else {
                postDetailContainer.innerHTML = `<div class="error-message">No post ID provided.</div>`;
                console.error("No post ID found in URL.");
            }

        });

    </script>
    <script src="script.js"></script>
</body>

</html>